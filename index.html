<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=420, initial-scale=1.0">
  <title>××•×“×¢×•×ª ×”×¦×¤×•×Ÿ - ×”×œ×•×— ×”×“×™×’×™×˜×œ×™ ×©×œ ×”×¦×¤×•×Ÿ</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="logo-modaot-hatzafon.svg">
  <style>
    body { font-family: 'Heebo', Arial, sans-serif; background: #f7fafc; margin: 0; }
    header {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
  box-shadow: 0 2px 8px #e0e0e0;
  padding: 24px 0 8px 0;
  position: sticky;
  top: 0;
  z-index: 1000;
}
    .logo { width: 220px; margin-bottom: 10px; }
    .subtitle { color: #333; font-size: 18px; margin-bottom: 0; }

    .ads-board { flex: 1; display: flex; flex-direction: column; gap: 24px; }
    .ads-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .ads-header .dates { font-size: 16px; color: #555; }
    .ads-header .parasha { font-size: 18px; color: #0099cc; font-weight: bold; }
    .filters { margin-bottom: 18px; }
    .filters select { font-size: 15px; padding: 4px 8px; border-radius: 6px; border: 1px solid #bbb; }
    .ad-card {
      background: #fff; border-radius: 16px; box-shadow: 0 2px 12px #e0e0e0;
      padding: 18px 18px 12px 18px; display: flex; flex-direction: column; gap: 10px;
      width: 100%; max-width: 800px; margin: 0 auto;
    }
    .ad-card .ad-image { width: 100%; border-radius: 12px; max-height: 350px; object-fit: contain; background: #f0f0f0; }
    .ad-card .ad-content { font-size: 17px; color: #222; }
    .ad-card .ad-dynamic { margin-top: 6px; font-size: 15px; color: #0099cc; }
    .ad-card .ad-actions {
      display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
    }
    .ad-card .ad-btn {
      border: none; border-radius: 8px; padding: 8px 14px;
      font-size: 15px; cursor: pointer; transition: background 0.2s;
      background: #0099cc; color: #fff; font-weight: bold;
      display: flex; align-items: center; gap: 6px;
    }
    .ad-card .ad-btn.whatsapp { background: #25d366; }
    .ad-card .ad-btn.link { background: #ffd600; color: #333; }
    .ad-card .ad-btn.email { background: #ff7043; }
    .a4-image {
  width: 794px !important; /* ×¨×•×—×‘ A4 ×‘-px */
  aspect-ratio: 210/297;
  max-width: 100vw !important;
  max-height: 100vh !important;
  height: auto !important;
  display: block;
  margin: 0 auto;
  object-fit: contain;
  background: #f0f0f0;
  border-radius: 12px;
  box-shadow: 0 2px 16px #e0e0e0;
}
    .ads-board {
  overflow-y: auto;
  max-height: none;
  min-height: 100vh;
  padding-bottom: 40px;
}
    @media (max-width: 820px) {
      .a4-image {
        width: 100vw !important;
        height: auto !important;
        max-width: 100vw !important;
        max-height: 65vh !important;
      }
      .ads-board {
        max-height: 70vh;
      }
    }
    .nav-btn {
      display: inline-block; background: #0099cc; color: #fff; font-weight: bold;
      padding: 8px 18px; border-radius: 8px; text-decoration: none; font-size: 16px;
      transition: background 0.2s, color 0.2s;
    }
    .nav-btn:hover { background: #ffd600; color: #222; }
    .badge {
      background-color: #ff5722;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 12px;
      margin-right: 5px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-btn {
      float: left;
      cursor: pointer;
      font-size: 20px;
    }
    @media (max-width: 900px) {
      .main-nav { flex-wrap: wrap; gap: 7px; }
      .nav-btn { font-size: 15px; padding: 7px 10px; }
    }
  </style>
</head>
<body>
  <!-- Scripts will be loaded at the bottom of the body -->
  <header>
  <div class="header-row">
    <img class="logo" src="logo-modaot-hatzafon.svg" alt="××•×“×¢×•×ª ×”×¦×¤×•×Ÿ ×œ×•×’×•">
    <nav class="main-nav">
      <button id="openFilterBarBtn" class="nav-btn" title="×¡×™× ×•×Ÿ ××ª×§×“×">
        <span class="filter-icon">ğŸ”</span> ×¡×™× ×•×Ÿ ××ª×§×“×
        <span id="selectedCityBadge" class="badge" style="display: none;"></span>
      </button>
      <a class="nav-btn" href="advertiser.html">â• ×”×¢×œ××ª ××•×“×¢×”</a>
      <a class="nav-btn" href="my-ads.html">ğŸ“‹ ×”××•×“×¢×•×ª ×©×œ×™</a>
      <a class="nav-btn" href="admin-categories.html">âš™ï¸ × ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</a>
    </nav>
  </div>
  <div class="subtitle">×”×œ×•×— ×”×“×™×’×™×˜×œ×™ ×©×œ ×”×¦×¤×•×Ÿ</div>
  <style>
    .header-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 0 16px;
      min-height: 64px;
    }
    .logo {
      width: 160px;
      margin-bottom: 0;
      margin-left: 12px;
    }
    .main-nav {
      display: flex;
      flex-direction: row;
      gap: 12px;
    }
    .subtitle {
      text-align: center;
      font-size: 18px;
      color: #333;
      margin-bottom: 0;
      margin-top: 2px;
    }
    @media (max-width: 600px) {
      .header-row { flex-direction: column; gap: 8px; padding: 0 4px; }
      .logo { width: 120px; margin-left: 0; }
      .main-nav { gap: 6px; flex-wrap: wrap; }
    }

    /* ×¡×’× ×•× ×•×ª ×œ×¡×¨×’×œ ×”×¡×™× ×•×Ÿ ×”××ª×§×“× */
    .filter-bar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .filter-bar {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      direction: rtl;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      overflow-y: auto;
    }

    .filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      align-items: flex-start;
    }

    .filter-btn {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #495057;
      transition: all 0.2s ease;
      white-space: nowrap;
      user-select: none;
    }

    .filter-btn input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #007bff;
      cursor: pointer;
    }

    .filter-btn:hover {
      background: #e9ecef;
      border-color: #dee2e6;
    }

    .filter-btn.selected {
      background: #007bff;
      border-color: #007bff;
      color: white;
    }

    .filter-btn .dropdown-arrow {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .city-dropdown {
      position: relative;
    }

    .city-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .neighborhoods-menu {
      width: 100%;
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      margin-top: 8px;
      padding: 8px;
      display: none;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .city-dropdown.open .neighborhoods-menu {
      display: block;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .neighborhood-item {
      padding: 0;
    }

    .neighborhood-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.2s ease;
      margin: 0;
      font-size: 14px;
      color: #495057;
    }

    .neighborhood-label:hover {
      background: #f8f9fa;
    }

    .neighborhood-label.selected {
      background: #e3f2fd;
      color: #1976d2;
    }

    .neighborhood-label input[type="checkbox"] {
      margin: 0;
      width: 16px;
      height: 16px;
      accent-color: #007bff;
    }

    .apply-filter-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 10px;
    }

    .apply-filter-btn:hover {
      background: #218838;
    }

    .filter-buttons-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .clear-filter-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .clear-filter-btn:hover {
      background: #c82333;
    }

    .close-filter-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s ease;
    }

    .close-filter-btn:hover {
      background: #e9ecef;
      color: #333;
    }

    /* ×¢×™×¦×•×‘ ×¨×¡×¤×•× ×¡×™×‘×™ */
    @media (max-width: 768px) {
      .filter-bar {
        min-width: 95vw;
        max-width: 95vw;
        padding: 15px;
        border-radius: 8px;
      }

      .filters-container {
        gap: 8px;
      }

      .filter-btn {
        padding: 8px 12px;
        font-size: 13px;
      }

      .neighborhoods-menu {
        min-width: 180px;
      }

      .neighborhood-label {
        padding: 8px 10px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .filter-bar {
        top: 20px;
        transform: translateX(-50%);
        left: 50%;
        width: 95vw;
        max-height: calc(100vh - 40px);
      }

      .filters-container {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-btn {
        justify-content: space-between;
      }

      .neighborhoods-menu {
        position: static;
        box-shadow: none;
        border: none;
        border-top: 1px solid #dee2e6;
        border-radius: 0;
        margin-top: 0;
      }
    }
  </style>
</header>

  <div class="main-layout">
    <!-- ×¡×¨×’×œ ×¡×™× ×•×Ÿ ××ª×§×“× -->
    <div id="filterBarOverlay" class="filter-bar-overlay"></div>
    <div id="filterBar" class="filter-bar" style="display: none;"></div>
    
    <nav class="categories-menu">
      <ul id="categoriesMenuUl"></ul>
    </nav>
    <main class="ads-board" id="adsBoard">
      <div class="ads-header">
        <span class="dates">×›"×“ ×‘×ª××•×– ×ª×©×¤"×” | 20.07.2025</span>
        <span class="parasha">×¤×¨×©×ª ××˜×•×ª-××¡×¢×™</span>
      </div>

      <!-- ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ ××•×“×¢×•×ª × ×•×¡×¤×•×ª -->
    </main>
  </div>
  
  <!-- Load scripts here, after the HTML is parsed but before renderAds is called -->
  <script src="categories-data.js"></script>
  <script src="cities-data.js"></script>
  <script src="filter-bar.js"></script>
  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js"></script>
  
  <script>
    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª×¤×¨×™×˜ ×”×§×˜×’×•×¨×™×•×ª ×‘×”×ª×× ×œ××•×“×¢×•×ª ×”××¡×•× × ×•×ª
    function updateCategoriesMenu(adsByCat, categoriesSource) {
      const menuUl = document.getElementById('categoriesMenuUl');
      if (!menuUl) return;
      
      menuUl.innerHTML = '';
      
      // ×”×•×¡×¤×ª ×§×˜×’×•×¨×™×™×ª "×”×›×œ" ×× ×™×© ×™×•×ª×¨ ××§×˜×’×•×¨×™×” ××—×ª
      if (Object.keys(adsByCat).length > 1) {
        const allLi = document.createElement('li');
        allLi.innerHTML = `<a href="#" style="background-color: #0099cc; color: white;">ğŸ  ×”×›×œ</a>`;
        allLi.style.padding = '10px 8px';
        allLi.style.marginBottom = '6px';
        allLi.style.borderRadius = '8px';
        allLi.style.cursor = 'pointer';
        allLi.style.display = 'flex';
        allLi.style.alignItems = 'center';
        allLi.style.transition = 'background 0.2s, color 0.2s';
        menuUl.appendChild(allLi);
      }
      
      // ×”×•×¡×¤×ª ×§×˜×’×•×¨×™×•×ª ×¢× ××•×“×¢×•×ª
      categoriesSource.forEach(cat => {
        const catName = typeof cat === 'object' ? cat.name : cat;
        if (adsByCat[catName] && adsByCat[catName].length > 0) {
          const catData = window.categoriesData?.find(c => c.name === catName) || {};
          const li = document.createElement('li');
          li.innerHTML = `<a href="#cat-${catName.replace(/\s+/g, '-')}">${catData.icon || 'ğŸ“Œ'} ${catName}</a>`;
          li.style.padding = '10px 8px';
          li.style.marginBottom = '6px';
          li.style.borderRadius = '8px';
          li.style.cursor = 'pointer';
          li.style.display = 'flex';
          li.style.alignItems = 'center';
          li.style.transition = 'background 0.2s, color 0.2s';
          li.dataset.cat = catName;
          li.dataset.bg = (catData.color || '#f0f0f0') + '22';
          li.dataset.color = catData.color || '#333';
          menuUl.appendChild(li);
        }
      });
      
      // ×”×•×¡×¤×ª ×§×˜×’×•×¨×™×™×ª "×œ×œ× ×§×˜×’×•×¨×™×”" ×× ×™×© ××•×“×¢×•×ª ×›××œ×”
      if (adsByCat['×œ×œ× ×§×˜×’×•×¨×™×”'] && adsByCat['×œ×œ× ×§×˜×’×•×¨×™×”'].length) {
        const li = document.createElement('li');
        li.innerHTML = `<a href="#cat-×œ×œ×-×§×˜×’×•×¨×™×”">ğŸ“Œ ×œ×œ× ×§×˜×’×•×¨×™×”</a>`;
        li.style.padding = '10px 8px';
        li.style.marginBottom = '6px';
        li.style.borderRadius = '8px';
        li.style.cursor = 'pointer';
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.transition = 'background 0.2s, color 0.2s';
        menuUl.appendChild(li);
      }
    }

    // ×˜×¢×Ÿ ××•×“×¢×•×ª ××”-localStorage, ×¡× ×Ÿ ×œ×¤×™ ×¢×™×¨ × ×‘×—×¨×ª ×•×”×¦×’ ××•×ª×Ÿ
    function renderAds(filteredAds) {
      let ads = Array.isArray(filteredAds) ? filteredAds : JSON.parse(localStorage.getItem('ads')||'[]');
      
      // ×× ×§×™×‘×œ× ×• ××•×“×¢×•×ª ××¡×•× × ×•×ª, × ×©×ª××© ×‘×”×Ÿ
      // ××—×¨×ª × ×¡× ×Ÿ ×œ×¤×™ ×¢×™×¨ × ×‘×—×¨×ª (×œ××¢×Ÿ ×ª××™××•×ª ×œ××—×•×¨)
      if (!Array.isArray(filteredAds)) {
        const selectedCity = localStorage.getItem('selectedCity');
        if (selectedCity) {
          ads = ads.filter(ad => ad.city === selectedCity);
        }
      }
      
      const board = document.getElementById('adsBoard');
      const demo = document.getElementById('demoAd');
      // Remove old ads
      board.querySelectorAll('.ad-card:not(.demo-ad), .ads-category-title').forEach(e => e.remove());
      if (ads.length > 0 && demo) demo.style.display = 'none';
      else if (demo) demo.style.display = '';
      
      // Get categories in the right order
      const categoriesSource = (function() {
        const savedOrder = localStorage.getItem('categoriesOrder');
        if (savedOrder) {
          try { 
            return JSON.parse(savedOrder); 
          } catch(e) {
            console.error('Error parsing categories order:', e);
            return window.categoriesData || [];
          }
        }
        return window.categoriesData || [];
      })();
      
      if (!categoriesSource || !categoriesSource.length) return;
  // ×§×™×‘×•×¥ ××•×“×¢×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”
  const adsByCat = {};
  ads.forEach(ad => {
    const cat = ad.category || '×œ×œ× ×§×˜×’×•×¨×™×”';
    if (!adsByCat[cat]) adsByCat[cat] = [];
    adsByCat[cat].push(ad);
  });

  // ×¢×“×›×•×Ÿ ×ª×¤×¨×™×˜ ×”×§×˜×’×•×¨×™×•×ª (ul#categoriesMenuUl) ×‘×”×ª×× ×œ××•×“×¢×•×ª ×”××¡×•× × ×•×ª
  updateCategoriesMenu(adsByCat, categoriesSource);

  // ×¢×‘×•×¨ ×›×œ ×§×˜×’×•×¨×™×” ×œ×¤×™ ×”×¡×“×¨
  categoriesSource.forEach(cat => {
    const catAds = adsByCat[cat.name];
    if (!catAds || !catAds.length) return;
    // ×›×•×ª×¨×ª ×§×˜×’×•×¨×™×”
    const title = document.createElement('div');
    title.className = 'ads-category-title';
    title.id = 'cat-' + cat.name.replace(/\s+/g, '-');
    title.style = `font-size:22px;font-weight:bold;margin:28px 0 10px 0;display:flex;align-items:center;gap:8px;color:${cat.color}`;
    title.innerHTML = `<span style='font-size:28px;'>${cat.icon||''}</span><span>${cat.name}</span>`;
    board.appendChild(title);
    // ×›×œ ×”××•×“×¢×•×ª ×©×œ ×”×§×˜×’×•×¨×™×”
    catAds.slice().reverse().forEach(ad => {
      const el = document.createElement('article');
      el.className = 'ad-card';
      let imgHtml = ad.img ? `<img class="ad-image a4-image" src="${ad.img}" alt="××•×“×¢×”">` : '';
      let dynamicHtml = '';
      if(ad.dynamic && ad.dynamic.length) {
        dynamicHtml = ad.dynamic.map(d=>`${d.field}: ${d.value}`).join(' | ');
      }
      el.innerHTML = `
        ${imgHtml}
        <div class="ad-content">${ad.content || ad.title || ''}</div>
        <div class="ad-location">
          ${ad.city ? `<span class='ad-city'>×¢×™×¨: ${ad.city}</span>` : ''}
          ${(ad.neighborhood && ad.neighborhood !== '') ? `<span class='ad-neighborhood'> | ×©×›×•× ×”: ${ad.neighborhood}</span>` : ''}
        </div>
        <div class="ad-dynamic">${dynamicHtml}</div>
        <div class="ad-actions">
          <button class="ad-btn whatsapp">ğŸ“ ${ad.phone || ''} ${ad.whatsapp ? '<span>×•×•××˜×¡××¤</span>' : ''}</button>
          ${ad.link ? `<button class="ad-btn link" onclick="window.open('${ad.link}','_blank')">ğŸ”— ×§×™×©×•×¨</button>` : ''}
          ${ad.email ? `<button class="ad-btn email" onclick="window.location.href='mailto:${ad.email}'">âœ‰ï¸ ×©×œ×— ×”×•×“×¢×”</button>` : ''}
        </div>
      `;
      board.appendChild(el);
    });
  });
  // ××•×“×¢×•×ª ×œ×œ× ×§×˜×’×•×¨×™×” (×× ×™×©)
  if (adsByCat['×œ×œ× ×§×˜×’×•×¨×™×”']) {
    const title = document.createElement('div');
    title.className = 'ads-category-title';
    title.style = 'font-size:22px;font-weight:bold;margin:28px 0 10px 0;display:flex;align-items:center;gap:8px;color:#888';
    title.innerHTML = `<span>×œ×œ× ×§×˜×’×•×¨×™×”</span>`;
    board.appendChild(title);
    adsByCat['×œ×œ× ×§×˜×’×•×¨×™×”'].slice().reverse().forEach(ad => {
      const el = document.createElement('article');
      el.className = 'ad-card';
      let imgHtml = ad.img ? `<img class=\"ad-image a4-image\" src=\"${ad.img}\" alt=\"××•×“×¢×”\">` : '';
      let dynamicHtml = '';
      if(ad.dynamic && ad.dynamic.length) {
        dynamicHtml = ad.dynamic.map(d=>`${d.field}: ${d.value}`).join(' | ');
      }
      el.innerHTML = `
        ${imgHtml}
        <div class=\"ad-content\">${ad.content || ad.title || ''}</div>
        <div class=\"ad-dynamic\">${dynamicHtml}</div>
        <div class=\"ad-actions\">
          <button class=\"ad-btn whatsapp\">ğŸ“ ${ad.phone || ''} ${ad.whatsapp ? '<span>×•×•××˜×¡××¤</span>' : ''}</button>
          ${ad.link ? `<button class=\"ad-btn link\" onclick=\"window.open('${ad.link}','_blank')\">ğŸ”— ×§×™×©×•×¨</button>` : ''}
          ${ad.email ? `<button class=\"ad-btn email\" onclick=\"window.location.href='mailto:${ad.email}'\">âœ‰ï¸ ×©×œ×— ×”×•×“×¢×”</button>` : ''}
        </div>
      `;
      board.appendChild(el);
    });
  }
}
window.addEventListener('DOMContentLoaded', renderAds);
    </script>
  </div>
  


<script>
// ×¨×™× ×“×•×¨ ×“×™× ××™ ×©×œ ×ª×¤×¨×™×˜ ×”×§×˜×’×•×¨×™×•×ª - ×©× + ××™×™×§×•×Ÿ + ×¦×‘×¢ ×¨×§×¢ ×œ-active
function renderCategoriesMenu() {
  const menu = document.getElementById('categoriesMenuUl');
  if (!menu) return;
  
  // ×§×‘×œ ××ª ×¡×“×¨ ×”×§×˜×’×•×¨×™×•×ª ××”-localStorage ××• ×”×©×ª××© ×‘×¡×“×¨ ×‘×¨×™×¨×ª ×”××—×“×œ
  const savedOrder = localStorage.getItem('categoriesOrder');
  let categoriesOrder = [];
  
  if (savedOrder) {
    try {
      categoriesOrder = JSON.parse(savedOrder);
    } catch (e) {
      console.error('Error parsing categories order:', e);
    }
  }
  
  // Get all ads to filter categories by selected city
  const allAds = JSON.parse(localStorage.getItem('ads') || '[]');
  const selectedCity = localStorage.getItem('selectedCity');
  
  // Filter ads by selected city if any
  const filteredAds = selectedCity 
    ? allAds.filter(ad => ad.city === selectedCity)
    : allAds;
    
  // Get unique categories from filtered ads
  const activeCategories = [...new Set(filteredAds.map(ad => ad.category))];
  
  menu.innerHTML = ''; // Clear existing menu
  
  // Get all categories in the desired order
  const categoriesSource = (() => {
    // First, get all visible categories from categoriesData
    const visibleCategories = window.categoriesData
      .filter(cat => cat.visible !== false)
      .map(cat => cat.name);
    
    // If we have a saved order, use it to sort the visible categories
    if (savedOrder) {
      try {
        const order = JSON.parse(savedOrder);
        // Filter and sort based on saved order, but only include active categories
        return order.filter(catName => 
          visibleCategories.includes(catName) && 
          activeCategories.includes(catName)
        );
      } catch (e) {
        console.error('Error parsing categories order:', e);
      }
    }
    // If no saved order or error, use default order from categoriesData
    // but only include categories that have ads in the current filter
    return visibleCategories.filter(catName => 
      activeCategories.includes(catName)
    );
  })();

  // Add 'All' category if there are multiple categories
  if (categoriesSource.length > 1) {
    const allLi = document.createElement('li');
    const allLink = document.createElement('a');
    allLink.href = '#';
    allLink.className = 'category-link';
    allLink.style.backgroundColor = '#0099cc';
    allLink.style.color = 'white';
    allLink.innerHTML = `
      <span class="category-icon">ğŸ </span>
      <span class="category-name">×”×›×œ</span>
    `;
    allLi.appendChild(allLink);
    menu.appendChild(allLi);
  }

  // Add each category to the menu
  categoriesSource.forEach(catName => {
    const catData = window.categoriesData.find(c => c.name === catName) || {};
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = `#${encodeURIComponent(catName)}`;
    a.className = 'category-link';
    a.style.backgroundColor = catData.color || '#f0f0f0';
    a.style.color = catData.textColor || '#333';
    a.innerHTML = `
      <span class="category-icon">${catData.icon || 'ğŸ“Œ'}</span>
      <span class="category-name">${catName}</span>
    `;
    li.appendChild(a);
    menu.appendChild(li);
  });

  // Add click handler for category links
  document.querySelectorAll('.category-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      
      // Update active state
      document.querySelectorAll('.category-link').forEach(el => {
        el.style.backgroundColor = '';
        el.style.color = '';
      });
      
      const clickedLink = e.currentTarget;
      clickedLink.style.backgroundColor = '#0099cc';
      clickedLink.style.color = 'white';
      
      // If 'All' was clicked, scroll to top
      if (clickedLink.querySelector('.category-name').textContent === '×”×›×œ') {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }
      
      // Otherwise, scroll to the selected category
      const categoryName = clickedLink.querySelector('.category-name').textContent;
      const element = document.getElementById(encodeURIComponent(categoryName));
      if (element) {
        element.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });

  let first = true;
  categoriesSource.forEach(cat => {
    if (!catsWithAds.has(cat.name)) return;
    const li = document.createElement('li');
    li.innerHTML = `<span style='font-size:20px;margin-left:6px;'>${cat.icon||''}</span><span>${cat.name}</span>`;
    li.style.padding = '10px 8px';
    li.style.marginBottom = '6px';
    li.style.borderRadius = '8px';
    li.style.cursor = 'pointer';
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.transition = 'background 0.2s, color 0.2s';
    li.dataset.cat = cat.name;
    li.dataset.bg = cat.color+'22';
    li.dataset.color = cat.color;
    if (first) {
      li.classList.add('active');
      li.style.background = cat.color+'22';
      li.style.color = cat.color;
      li.style.fontWeight = 'bold';
      first = false;
    }
    li.onclick = function() {
      ul.querySelectorAll('li').forEach(el => {
        el.classList.remove('active');
        el.style.background = '';
        el.style.color = '';
        el.style.fontWeight = '';
      });
      li.classList.add('active');
      li.style.background = cat.color+'22';
      li.style.color = cat.color;
      li.style.fontWeight = 'bold';
      // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×›×•×ª×¨×ª ×”×§×˜×’×•×¨×™×”
      const targetId = 'cat-' + cat.name.replace(/\s+/g, '-');
      const target = document.getElementById(targetId);
      if(target) {
        const offset = 110; // ×’×•×‘×” ×”×¡×¨×’×œ ×”×¢×œ×™×•×Ÿ
        const top = target.getBoundingClientRect().top + window.scrollY - offset;
        window.scrollTo({top, behavior:'smooth'});
      }
    };
    ul.appendChild(li);
  });
}
document.addEventListener('DOMContentLoaded', renderCategoriesMenu);
// ×¨×¢× ×•×Ÿ ×”×ª×¤×¨×™×˜ ×‘×›×œ ×©×™× ×•×™ ×‘××•×“×¢×•×ª
window.addEventListener('storage', renderCategoriesMenu);

// ×”×“×’×©×” ××•×˜×•××˜×™×ª ×©×œ ×§×˜×’×•×¨×™×” ×‘×ª×¤×¨×™×˜ ×”×“×‘×™×§ ×œ×¤×™ ×’×œ×™×œ×”
function updateActiveCategoryOnScroll() {
  const titles = Array.from(document.querySelectorAll('.ads-category-title'));
  const menuLis = Array.from(document.querySelectorAll('#categoriesMenuUl li'));
  if (!titles.length || !menuLis.length) return;
  let activeIdx = 0;
  const offset = 120; // ×›×•×•×Ÿ ×œ×¤×™ ×’×•×‘×” ×”×¡×¨×’×œ ×”×¢×œ×™×•×Ÿ
  titles.forEach((title, i) => {
    const rect = title.getBoundingClientRect();
    if (rect.top - offset < 0) activeIdx = i;
  });
  menuLis.forEach((li, i) => {
    if (i === activeIdx) {
      li.classList.add('active');
      li.style.background = li.dataset.bg;
      li.style.color = li.dataset.color;
      li.style.fontWeight = 'bold';
    } else {
      li.classList.remove('active');
      li.style.background = '';
      li.style.color = '';
      li.style.fontWeight = '';
    }
  });
}
window.addEventListener('scroll', updateActiveCategoryOnScroll);
window.addEventListener('DOMContentLoaded', updateActiveCategoryOnScroll);

// ×¢×“×›×•×Ÿ ×ª×’ ×”×¡×™× ×•×Ÿ ×›×©××©×ª××©×™× ×‘×¡×™× ×•×Ÿ ×”××ª×§×“×
function updateFilterBadge() {
  const badge = document.getElementById('selectedCityBadge');
  if (window.selectedCityFilters && window.selectedCityFilters.length > 0) {
    badge.textContent = `${window.selectedCityFilters.length} ×¢×¨×™×`;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

// ×§×¨×™××” ×œ×¢×“×›×•×Ÿ ×”×ª×’ ×›×©×”×“×£ × ×˜×¢×Ÿ
document.addEventListener('DOMContentLoaded', updateFilterBadge);

// Add some styles for the city buttons
const style = document.createElement('style');
style.textContent = `
  .city-btn {
    display: block;
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f9f9f9;
    cursor: pointer;
    text-align: right;
    transition: all 0.2s;
  }
  .city-btn:hover {
    background: #e9e9e9;
  }
  .city-btn.selected {
    background: #0099cc;
    color: white;
    border-color: #0088bb;
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
