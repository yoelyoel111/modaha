<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=420, initial-scale=1.0">
  <title>מודעות הצפון - הלוח הדיגיטלי של הצפון</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="logo-modaot-hatzafon.svg">
  <style>
    body { font-family: 'Heebo', Arial, sans-serif; background: #f7fafc; margin: 0; }
    header {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
  padding: 20px 0 12px 0;
  position: sticky;
  top: 0;
  z-index: 1000;
  border-bottom: 1px solid rgba(0, 153, 204, 0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
    .logo { width: 220px; margin-bottom: 10px; }
    .subtitle { color: #333; font-size: 18px; margin-bottom: 0; }

    .ads-board { flex: 1; display: flex; flex-direction: column; gap: 24px; }
    .ads-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .ads-header .dates { font-size: 16px; color: #555; }
    .ads-header .parasha { font-size: 18px; color: #0099cc; font-weight: bold; }
    .filters { margin-bottom: 18px; }
    .filters select { font-size: 15px; padding: 4px 8px; border-radius: 6px; border: 1px solid #bbb; }
    .ad-card {
      background: #fff; border-radius: 16px; box-shadow: 0 2px 12px #e0e0e0;
      padding: 18px 18px 12px 18px; display: flex; flex-direction: column; gap: 10px;
      width: 100%; max-width: 800px; margin: 0 auto;
    }
    .ad-card .ad-image { width: 100%; border-radius: 12px; max-height: 350px; object-fit: contain; background: #f0f0f0; }
    .ad-card .ad-content { font-size: 17px; color: #222; }
    .ad-card .ad-dynamic { margin-top: 6px; font-size: 15px; color: #0099cc; }
    .ad-card .ad-actions {
      display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
    }
    .ad-card .ad-btn {
      border: none; border-radius: 8px; padding: 8px 14px;
      font-size: 15px; cursor: pointer; transition: background 0.2s;
      background: #0099cc; color: #fff; font-weight: bold;
      display: flex; align-items: center; gap: 6px;
    }
    .ad-card .ad-btn.whatsapp { background: #25d366; }
    .ad-card .ad-btn.link { background: #ffd600; color: #333; }
    .ad-card .ad-btn.email { background: #ff7043; }
    .a4-image {
  width: 794px !important; /* רוחב A4 ב-px */
  aspect-ratio: 210/297;
  max-width: 100vw !important;
  max-height: 100vh !important;
  height: auto !important;
  display: block;
  margin: 0 auto;
  object-fit: contain;
  background: #f0f0f0;
  border-radius: 12px;
  box-shadow: 0 2px 16px #e0e0e0;
}
    .ads-board {
  overflow-y: auto;
  max-height: none;
  min-height: 100vh;
  padding-bottom: 40px;
}
    @media (max-width: 820px) {
      .a4-image {
        width: 100vw !important;
        height: auto !important;
        max-width: 100vw !important;
        max-height: 65vh !important;
      }
      .ads-board {
        max-height: 70vh;
      }
    }
    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #0099cc 0%, #007ab8 100%);
      color: #fff;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(0, 153, 204, 0.2);
      transform: translateY(0);
    }
    .nav-btn:hover {
      background: linear-gradient(135deg, #ffd600 0%, #ffcc00 100%);
      color: #1a1a1a;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 214, 0, 0.3);
      border-color: rgba(255, 214, 0, 0.5);
    }
    .nav-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 153, 204, 0.2);
    }
    
    #openFilterBarBtn {
      position: relative;
    }
    
    /* וידוא שתפריט הסינון מופיע מתחת לכפתור */
    #openFilterBarBtn + .filter-bar {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
    }
    .badge {
      background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%);
      color: white;
      border-radius: 12px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 6px;
      min-width: 20px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(255, 87, 34, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-btn {
      float: left;
      cursor: pointer;
      font-size: 20px;
    }
    @media (max-width: 900px) {
      .main-nav { 
        flex-wrap: wrap; 
        gap: 12px; 
        justify-content: center;
      }
      .nav-btn { 
        font-size: 14px; 
        padding: 10px 14px;
        min-width: fit-content;
      }
      .header-row {
        gap: 20px;
        padding: 0 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Scripts will be loaded at the bottom of the body -->
  <header role="banner">
  <div class="header-row">
    <img class="logo" src="logo-modaot-hatzafon.svg" alt="מודעות הצפון לוגו" role="img">
    <nav class="main-nav" role="navigation" aria-label="תפריט ניווט ראשי">
      <button id="openFilterBarBtn" class="nav-btn" title="סינון מתקדם" 
              aria-label="פתח סינון מתקדם לפי ערים ושכונות"
              aria-expanded="false" aria-haspopup="dialog">
        <span class="filter-icon" aria-hidden="true">🔍</span> סינון מתקדם
        <span id="selectedCityBadge" class="badge" style="display: none;" aria-live="polite"></span>
      </button>
      <a class="nav-btn" href="advertiser.html" aria-label="העלה מודעה חדשה">
        <span aria-hidden="true">➕</span> העלאת מודעה
      </a>
      <a class="nav-btn" href="my-ads.html" aria-label="צפה במודעות שלי">
        <span aria-hidden="true">📋</span> המודעות שלי
      </a>
      <a class="nav-btn" href="admin-categories.html" aria-label="נהל קטגוריות">
        <span aria-hidden="true">⚙️</span> ניהול קטגוריות
      </a>
    </nav>
  </div>
  <div class="subtitle" role="doc-subtitle">הלוח הדיגיטלי של הצפון</div>
  
  <!-- תפריט סינון מתקדם מתחת לכפתור -->
  <div id="filterBar" class="filter-bar" style="display: none;" 
       role="dialog" aria-modal="true" aria-labelledby="filter-dialog-title" 
       aria-hidden="true"></div>
  

  <style>
    .header-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 32px;
      padding: 0 24px;
      min-height: 72px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    .logo {
      width: 180px;
      margin-bottom: 0;
      margin-left: 0;
      transition: transform 0.3s ease;
    }
    .logo:hover {
      transform: scale(1.05);
    }
    .main-nav {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    .subtitle {
      text-align: center;
      font-size: 18px;
      color: #555;
      margin-bottom: 8px;
      margin-top: 8px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    @media (max-width: 600px) {
      .header-row { 
        flex-direction: column; 
        gap: 16px; 
        padding: 0 16px; 
        min-height: auto;
      }
      .logo { 
        width: 140px; 
        margin-left: 0; 
      }
      .main-nav { 
        gap: 12px; 
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
      }
      .nav-btn {
        padding: 10px 16px;
        font-size: 14px;
        min-width: fit-content;
      }
      .subtitle {
        font-size: 16px;
        margin-top: 4px;
        margin-bottom: 4px;
      }
      header {
        padding: 16px 0 8px 0;
      }
      
      .filter-bar {
        margin: 5px;
        padding: 10px;
        width: 95%;
        left: 2.5%;
        transform: none;
      }
      
      .filters-container {
        gap: 6px;
      }
      
      .filter-btn {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .neighborhoods-menu {
        min-width: 180px;
        max-height: 150px;
        right: -10px;
      }
      
      .neighborhood-label {
        font-size: 12px;
        padding: 5px 8px;
      }
    }

    /* סגנונות לסרגל הסינון המתקדם */
    .filter-bar-overlay {
      display: none;
    }

    .filter-bar {
      position: absolute;
      top: 100%;
      right: 20px;
      width: 90%;
      max-width: 600px;
      margin: 0;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 15px;
      direction: rtl;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      overflow: visible;
    }

    .close-filter-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #ff5722;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .close-filter-btn:hover {
      background: #d84315;
    }

    .filter-bar h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      text-align: center;
      color: #333;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .apply-filter-btn, .clear-filter-btn {
      background: #0099cc;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }

    .apply-filter-btn:hover {
      background: #007a99;
    }

    .clear-filter-btn {
      background: #ff5722;
    }

    .clear-filter-btn:hover {
      background: #d84315;
    }

    .filters-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      margin-bottom: 15px;
      align-items: flex-start;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .filter-btn {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #e9ecef;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .filter-btn:hover {
      background: #dee2e6;
    }

    .filter-btn.selected {
      background: #0099cc;
      color: white;
      border-color: #0099cc;
    }

    .filter-btn {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #495057;
      transition: all 0.2s ease;
      white-space: nowrap;
      user-select: none;
      padding: 8px 12px;
      min-width: fit-content;
    }

    .filter-btn input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #007bff;
      cursor: pointer;
    }

    .filter-btn .dropdown-arrow {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .city-dropdown {
      position: relative;
    }

    .city-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .neighborhoods-menu {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 200px;
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-top: 5px;
      padding: 8px;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      min-height: 0;
      max-height: 80vh;
      height: auto;
      overflow-y: auto;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      border: 2px solid #0099cc;
    }

    .filter-bar {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 1200px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 15px;
      direction: rtl;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      overflow: visible;
      margin-top: 5px;
    }

    .city-dropdown {
      position: relative;
    }

    .city-dropdown.open .neighborhoods-menu {
      display: block;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .neighborhood-item {
      padding: 0;
    }

    .neighborhood-label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px 0;
      font-size: 13px;
      color: #495057;
      border-radius: 4px;
      background: #f8f9fa;
      border: 1px solid transparent;
      font-weight: 500;
    }

    .neighborhood-label:hover {
      background: #e9ecef;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .neighborhood-label.selected {
      background: #0099cc;
      color: white;
      border-color: #0099cc;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 153, 204, 0.3);
    }



    .neighborhood-label input[type="checkbox"] {
      margin: 0;
      width: 16px;
      height: 16px;
      accent-color: #0099cc;
      cursor: pointer;
    }

    /* וידוא שתפריט השכונות מופיע מעל הכל */
    .filter-bar * {
      overflow: visible;
    }

    .apply-filter-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 10px;
    }

    .apply-filter-btn:hover {
      background: #218838;
    }

    .filter-buttons-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .clear-filter-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .clear-filter-btn:hover {
      background: #c82333;
    }

    .close-filter-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s ease;
    }

    .close-filter-btn:hover {
      background: #e9ecef;
      color: #333;
    }

    /* עיצוב רספונסיבי */
    @media (max-width: 768px) {
      .filter-bar {
        min-width: 95vw;
        max-width: 95vw;
        padding: 15px;
        border-radius: 8px;
      }

      .filters-container {
        gap: 8px;
      }

      .filter-btn {
        padding: 8px 12px;
        font-size: 13px;
      }

      .neighborhoods-menu {
        min-width: 180px;
      }

      .neighborhood-label {
        padding: 8px 10px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .filter-bar {
        top: 20px;
        transform: translateX(-50%);
        left: 50%;
        width: 95vw;
        max-height: calc(100vh - 40px);
      }

      .filters-container {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-btn {
        justify-content: space-between;
      }

      .neighborhoods-menu {
        position: static;
        box-shadow: none;
        border: none;
        border-top: 1px solid #dee2e6;
        border-radius: 0;
        margin-top: 0;
      }
    }
  </style>
</header>



  <div class="main-layout">
    <!-- סרגל סינון מתקדם -->
    <div id="filterBarOverlay" class="filter-bar-overlay" aria-hidden="true"></div>
    
    <nav class="categories-menu" role="navigation" aria-label="תפריט קטגוריות">
      <ul id="categoriesMenuUl" role="menubar" aria-label="רשימת קטגוריות"></ul>
    </nav>
    <main class="ads-board" id="adsBoard" role="main" aria-label="לוח מודעות">
      <div class="ads-header" role="banner" aria-label="כותרת לוח המודעות">
        <span class="dates" aria-label="תאריך עברי ולועזי">כ"ד בתמוז תשפ"ה | 20.07.2025</span>
        <span class="parasha" aria-label="פרשת השבוע">פרשת מטות-מסעי</span>
      </div>

      <!-- אפשר להוסיף כאן מודעות נוספות -->
    </main>
  </div>
  
  <!-- Load scripts here, after the HTML is parsed but before renderAds is called -->
  <script src="categories-data.js"></script>
  <script src="cities-data.js"></script>
  <script src="filter-bar.js"></script>
  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js"></script>
  
  <script>
    // פונקציה לעדכון תפריט הקטגוריות בהתאם למודעות המסוננות
    const updateCategoriesMenu = (adsByCat, categoriesSource) => {
      const menuUl = document.getElementById('categoriesMenuUl');
      if (!menuUl) return;
      
      menuUl.innerHTML = '';
      
      // הוספת קטגוריית "הכל" אם יש יותר מקטגוריה אחת
      if (Object.keys(adsByCat).length > 1) {
        const allLi = document.createElement('li');
        allLi.innerHTML = `<a href="#" style="background-color: #0099cc; color: white;">🏠 הכל</a>`;
        Object.assign(allLi.style, {
          padding: '10px 8px',
          marginBottom: '6px',
          borderRadius: '8px',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          transition: 'background 0.2s, color 0.2s'
        });
        menuUl.appendChild(allLi);
      }
      
      // הוספת קטגוריות עם מודעות
      categoriesSource.forEach(cat => {
        const catName = typeof cat === 'object' ? cat.name : cat;
        if (adsByCat[catName]?.length > 0) {
          const catData = window.categoriesData?.find(c => c.name === catName) || {};
          const li = document.createElement('li');
          li.innerHTML = `<a href="#cat-${catName.replace(/\s+/g, '-')}">${catData.icon || '📌'} ${catName}</a>`;
          Object.assign(li.style, {
            padding: '10px 8px',
            marginBottom: '6px',
            borderRadius: '8px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            transition: 'background 0.2s, color 0.2s'
          });
          Object.assign(li.dataset, {
            cat: catName,
            bg: (catData.color || '#f0f0f0') + '22',
            color: catData.color || '#333'
          });
          menuUl.appendChild(li);
        }
      });
      
      // הוספת קטגוריית "ללא קטגוריה" אם יש מודעות כאלה
      if (adsByCat['ללא קטגוריה']?.length) {
        const li = document.createElement('li');
        li.innerHTML = `<a href="#cat-ללא-קטגוריה">📌 ללא קטגוריה</a>`;
        Object.assign(li.style, {
          padding: '10px 8px',
          marginBottom: '6px',
          borderRadius: '8px',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          transition: 'background 0.2s, color 0.2s'
        });
        menuUl.appendChild(li);
      }
    };

    // טען מודעות מה-localStorage, סנן לפי עיר נבחרת והצג אותן
    const renderAds = async (filteredAds) => {
      try {
        let ads = Array.isArray(filteredAds) ? 
          filteredAds : 
          SafeStorage.get('ads', []);
        
        // בדיקת תקינות נתונים
        if (!Array.isArray(ads)) {
          console.warn('Invalid ads data format, using empty array');
          ads = [];
        }
        
        // ניקוי נתונים לא תקינים
        ads = ads.filter(ad => DataValidator.validateAd(ad));
        
        const board = document.getElementById('adsBoard');
        const demo = document.getElementById('demoAd');
        
        if (!board) {
          throw new Error('Ads board element not found');
        }
        
        // Remove old ads with better performance
        const elementsToRemove = board.querySelectorAll('.ad-card:not(.demo-ad), .ads-category-title');
        const fragment = document.createDocumentFragment();
        
        // Move elements to fragment for batch removal
        elementsToRemove.forEach(el => fragment.appendChild(el));
        
        // Show/hide demo based on ads availability
        if (demo) {
          demo.style.display = ads.length > 0 ? 'none' : '';
        }
        
        // Get categories with improved error handling
        const categoriesSource = (() => {
          try {
            const savedOrder = SafeStorage.get('categoriesOrder');
            if (Array.isArray(savedOrder)) return savedOrder;
          } catch(e) {
            console.warn('Error parsing categories order:', e);
          }
          return window.categoriesData || [];
        })();
        
        if (!categoriesSource?.length) {
          console.warn('No categories data available');
          return;
        }

        // קיבוץ מודעות לפי קטגוריה עם Map
        const adsByCat = new Map();
        ads.forEach(ad => {
          const cat = ad.category || 'ללא קטגוריה';
          if (!adsByCat.has(cat)) {
            adsByCat.set(cat, []);
          }
          adsByCat.get(cat).push(ad);
        });

        // עדכון תפריט הקטגוריות
        updateCategoriesMenu(Object.fromEntries(adsByCat), categoriesSource);

        // רינדור מודעות לפי קטגוריות עם performance optimization
        const adsFragment = document.createDocumentFragment();
        
        for (const cat of categoriesSource) {
          const catAds = adsByCat.get(cat.name);
          if (!catAds?.length) continue;
          
          // כותרת קטגוריה
          const title = document.createElement('div');
          title.className = 'ads-category-title';
          title.id = `cat-${cat.name.replace(/\s+/g, '-')}`;
          title.setAttribute('role', 'heading');
          title.setAttribute('aria-level', '2');
          title.style.cssText = `font-size:22px;font-weight:bold;margin:28px 0 10px 0;display:flex;align-items:center;gap:8px;color:${cat.color}`;
          title.innerHTML = `<span style='font-size:28px;' aria-hidden="true">${cat.icon||''}</span><span>${cat.name}</span>`;
          adsFragment.appendChild(title);
          
          // מודעות הקטגוריה
          catAds.slice().reverse().forEach(ad => {
            const adElement = createAdElement(ad);
            if (adElement) adsFragment.appendChild(adElement);
          });
        }
        
        // הוספת מודעות ללא קטגוריה
        const uncategorizedAds = adsByCat.get('ללא קטגוריה');
        if (uncategorizedAds?.length) {
          const title = document.createElement('div');
          title.className = 'ads-category-title';
          title.setAttribute('role', 'heading');
          title.setAttribute('aria-level', '2');
          title.style.cssText = 'font-size:22px;font-weight:bold;margin:28px 0 10px 0;display:flex;align-items:center;gap:8px;color:#888';
          title.innerHTML = `<span>ללא קטגוריה</span>`;
          adsFragment.appendChild(title);
          
          uncategorizedAds.slice().reverse().forEach(ad => {
            const adElement = createAdElement(ad);
            if (adElement) adsFragment.appendChild(adElement);
          });
        }
        
        // הוספה אחת של כל המודעות
        board.appendChild(adsFragment);
        
      } catch (error) {
        console.error('Error rendering ads:', error);
        // Fallback UI
        const board = document.getElementById('adsBoard');
        if (board) {
          board.innerHTML = '<div class="error-message">שגיאה בטעינת המודעות. אנא רענן את הדף.</div>';
        }
      }
    };

    // פונקציה ליצירת אלמנט מודעה
    const createAdElement = (ad) => {
      try {
        const el = document.createElement('article');
        el.className = 'ad-card';
        el.setAttribute('role', 'article');
        el.setAttribute('aria-label', `מודעה: ${ad.content || ad.title || 'ללא כותרת'}`);
        
        const imgHtml = ad.img ? 
          `<img class="ad-image a4-image" src="${ad.img}" alt="תמונת מודעה" loading="lazy">` : 
          '';
        
        const dynamicHtml = ad.dynamic?.length ? 
          ad.dynamic.map(d => `${DataValidator.sanitizeHtml(d.field)}: ${DataValidator.sanitizeHtml(d.value)}`).join(' | ') :
          '';
          
        const locationHtml = `
          ${ad.city ? `<span class='ad-city'>עיר: ${DataValidator.sanitizeHtml(ad.city)}</span>` : ''}
          ${(ad.neighborhood && ad.neighborhood !== '') ? ` | שכונה: ${DataValidator.sanitizeHtml(ad.neighborhood)}` : ''}
        `.trim();
        
        el.innerHTML = `
          ${imgHtml}
          <div class="ad-content">${DataValidator.sanitizeHtml(ad.content || ad.title || '')}</div>
          ${locationHtml ? `<div class="ad-location">${locationHtml}</div>` : ''}
          <div class="ad-dynamic">${dynamicHtml}</div>
          <div class="ad-actions">
            ${ad.phone ? `<button class="ad-btn whatsapp" aria-label="התקשר ל${ad.phone}">📞 ${DataValidator.sanitizeHtml(ad.phone)} ${ad.whatsapp ? '<span>וואטסאפ</span>' : ''}</button>` : ''}
            ${ad.link && DataValidator.isValidUrl(ad.link) ? `<button class="ad-btn link" onclick="window.open('${ad.link}','_blank')" aria-label="פתח קישור חיצוני">🔗 קישור</button>` : ''}
            ${ad.email && DataValidator.isValidEmail(ad.email) ? `<button class="ad-btn email" onclick="window.location.href='mailto:${ad.email}'" aria-label="שלח אימייל ל${ad.email}">✉️ שלח הודעה</button>` : ''}
          </div>
        `;
        
        return el;
      } catch (error) {
        console.error('Error creating ad element:', error);
        return null;
      }
    };
window.addEventListener('DOMContentLoaded', renderAds);
    </script>
  </div>
  


<script>
// רינדור דינמי של תפריט הקטגוריות - שם + אייקון + צבע רקע ל-active
function renderCategoriesMenu() {
  const menu = document.getElementById('categoriesMenuUl');
  if (!menu) return;
  
  // קבל את סדר הקטגוריות מה-localStorage או השתמש בסדר ברירת המחדל
  const savedOrder = localStorage.getItem('categoriesOrder');
  let categoriesOrder = [];
  
  if (savedOrder) {
    try {
      categoriesOrder = JSON.parse(savedOrder);
    } catch (e) {
      console.error('Error parsing categories order:', e);
    }
  }
  
  // Get all ads to filter categories by selected city
  const allAds = JSON.parse(localStorage.getItem('ads') || '[]');
  const selectedCity = localStorage.getItem('selectedCity');
  
  // Filter ads by selected city if any
  const filteredAds = selectedCity 
    ? allAds.filter(ad => ad.city === selectedCity)
    : allAds;
    
  // Get unique categories from filtered ads
  const activeCategories = [...new Set(filteredAds.map(ad => ad.category))];
  
  menu.innerHTML = ''; // Clear existing menu
  
  // Get all categories in the desired order
  const categoriesSource = (() => {
    // First, get all visible categories from categoriesData
    const visibleCategories = window.categoriesData
      .filter(cat => cat.visible !== false)
      .map(cat => cat.name);
    
    // If we have a saved order, use it to sort the visible categories
    if (savedOrder) {
      try {
        const order = JSON.parse(savedOrder);
        // Filter and sort based on saved order, but only include active categories
        return order.filter(catName => 
          visibleCategories.includes(catName) && 
          activeCategories.includes(catName)
        );
      } catch (e) {
        console.error('Error parsing categories order:', e);
      }
    }
    // If no saved order or error, use default order from categoriesData
    // but only include categories that have ads in the current filter
    return visibleCategories.filter(catName => 
      activeCategories.includes(catName)
    );
  })();



  // Add each category to the menu
  categoriesSource.forEach(catName => {
    const catData = window.categoriesData.find(c => c.name === catName) || {};
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = `#${encodeURIComponent(catName)}`;
    a.className = 'category-link';
    a.style.backgroundColor = catData.color || '#f0f0f0';
    a.style.color = catData.textColor || '#333';
    a.innerHTML = `
      <span class="category-icon">${catData.icon || '📌'}</span>
      <span class="category-name">${catName}</span>
    `;
    li.appendChild(a);
    menu.appendChild(li);
  });

  // Add click handler for category links
  document.querySelectorAll('.category-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      
      // Update active state
      document.querySelectorAll('.category-link').forEach(el => {
        el.style.backgroundColor = '';
        el.style.color = '';
      });
      
      const clickedLink = e.currentTarget;
      clickedLink.style.backgroundColor = '#0099cc';
      clickedLink.style.color = 'white';
      

      
      // Otherwise, scroll to the selected category
      const categoryName = clickedLink.querySelector('.category-name').textContent;
      const element = document.getElementById(encodeURIComponent(categoryName));
      if (element) {
        element.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });

  let first = true;
  categoriesSource.forEach(cat => {
    if (!catsWithAds.has(cat.name)) return;
    const li = document.createElement('li');
    li.innerHTML = `<span style='font-size:20px;margin-left:6px;'>${cat.icon||''}</span><span>${cat.name}</span>`;
    li.style.padding = '10px 8px';
    li.style.marginBottom = '6px';
    li.style.borderRadius = '8px';
    li.style.cursor = 'pointer';
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.transition = 'background 0.2s, color 0.2s';
    li.dataset.cat = cat.name;
    li.dataset.bg = cat.color+'22';
    li.dataset.color = cat.color;
    if (first) {
      li.classList.add('active');
      li.style.background = cat.color+'22';
      li.style.color = cat.color;
      li.style.fontWeight = 'bold';
      first = false;
    }
    li.onclick = function() {
      ul.querySelectorAll('li').forEach(el => {
        el.classList.remove('active');
        el.style.background = '';
        el.style.color = '';
        el.style.fontWeight = '';
      });
      li.classList.add('active');
      li.style.background = cat.color+'22';
      li.style.color = cat.color;
      li.style.fontWeight = 'bold';
      // גלילה אוטומטית לכותרת הקטגוריה
      const targetId = 'cat-' + cat.name.replace(/\s+/g, '-');
      const target = document.getElementById(targetId);
      if(target) {
        const offset = 110; // גובה הסרגל העליון
        const top = target.getBoundingClientRect().top + window.scrollY - offset;
        window.scrollTo({top, behavior:'smooth'});
      }
    };
    ul.appendChild(li);
  });
}
document.addEventListener('DOMContentLoaded', renderCategoriesMenu);
// רענון התפריט בכל שינוי במודעות
window.addEventListener('storage', renderCategoriesMenu);

// הדגשה אוטומטית של קטגוריה בתפריט הדביק לפי גלילה
function updateActiveCategoryOnScroll() {
  const titles = Array.from(document.querySelectorAll('.ads-category-title'));
  const menuLis = Array.from(document.querySelectorAll('#categoriesMenuUl li'));
  if (!titles.length || !menuLis.length) return;
  let activeIdx = 0;
  const offset = 120; // כוון לפי גובה הסרגל העליון
  titles.forEach((title, i) => {
    const rect = title.getBoundingClientRect();
    if (rect.top - offset < 0) activeIdx = i;
  });
  menuLis.forEach((li, i) => {
    if (i === activeIdx) {
      li.classList.add('active');
      li.style.background = li.dataset.bg;
      li.style.color = li.dataset.color;
      li.style.fontWeight = 'bold';
    } else {
      li.classList.remove('active');
      li.style.background = '';
      li.style.color = '';
      li.style.fontWeight = '';
    }
  });
}
window.addEventListener('scroll', updateActiveCategoryOnScroll);
window.addEventListener('DOMContentLoaded', updateActiveCategoryOnScroll);

// עדכון תג הסינון כשמשתמשים בסינון המתקדם
function updateFilterBadge() {
  const badge = document.getElementById('selectedCityBadge');
  if (window.selectedCityFilters && window.selectedCityFilters.length > 0) {
    badge.textContent = `${window.selectedCityFilters.length} ערים`;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

// קריאה לעדכון התג כשהדף נטען
document.addEventListener('DOMContentLoaded', updateFilterBadge);

// Add some styles for the city buttons
const style = document.createElement('style');
style.textContent = `
  .city-btn {
    display: block;
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f9f9f9;
    cursor: pointer;
    text-align: right;
    transition: all 0.2s;
  }
  .city-btn:hover {
    background: #e9e9e9;
  }
  .city-btn.selected {
    background: #0099cc;
    color: white;
    border-color: #0088bb;
  }
`;
document.head.appendChild(style);

// Utility functions for data validation and sanitization
const DataValidator = {
  // בדיקת תקינות מודעה
  validateAd(ad) {
    if (!ad || typeof ad !== 'object') return false;
    
    // בדיקת שדות חובה
    const hasContent = ad.content || ad.title || ad.img;
    if (!hasContent) return false;
    
    // בדיקת אורך תוכן
    if (ad.content && ad.content.length > 5000) return false;
    if (ad.title && ad.title.length > 200) return false;
    
    // בדיקת פורמט טלפון
    if (ad.phone && !this.isValidPhone(ad.phone)) return false;
    
    // בדיקת פורמט אימייל
    if (ad.email && !this.isValidEmail(ad.email)) return false;
    
    // בדיקת URL
    if (ad.link && !this.isValidUrl(ad.link)) return false;
    
    return true;
  },

  // בדיקת תקינות מספר טלפון
  isValidPhone(phone) {
    const phoneRegex = /^[\d\-\s\+\(\)]{7,15}$/;
    return phoneRegex.test(phone);
  },

  // בדיקת תקינות אימייל
  isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  },

  // בדיקת תקינות URL
  isValidUrl(url) {
    try {
      new URL(url);
      return true;
    } catch {
      return false;
    }
  },

  // ניקוי HTML מתוכן
  sanitizeHtml(text) {
    if (typeof text !== 'string') return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  },

  // בדיקת תקינות קטגוריה
  isValidCategory(category) {
    if (!category || typeof category !== 'string') return false;
    if (!window.categoriesData) return true; // אם אין נתוני קטגוריות, מאשרים הכל
    return window.categoriesData.some(cat => cat.name === category);
  }
};

// Error handling wrapper for localStorage operations
const SafeStorage = {
  get(key, defaultValue = null) {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch (error) {
      console.error(`Error reading from localStorage (${key}):`, error);
      return defaultValue;
    }
  },

  set(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (error) {
      console.error(`Error writing to localStorage (${key}):`, error);
      return false;
    }
  },

  remove(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error(`Error removing from localStorage (${key}):`, error);
      return false;
    }
  }
};

// הוספת אפקט סקרול לתפריט העליון
let lastScrollTop = 0;
let isScrolling = false;

function handleHeaderScroll() {
  const header = document.querySelector('header');
  const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
  
  if (currentScroll > lastScrollTop && currentScroll > 100) {
    // גלילה למטה - הקטן מעט את הhader
    header.style.transform = 'translateY(-10px)';
    header.style.boxShadow = '0 2px 15px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1)';
  } else {
    // גלילה למעלה או בראש העמוד - החזר למקום
    header.style.transform = 'translateY(0)';
    header.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05)';
  }
  
  lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
}

// הוספת event listener לסקרול עם throttling
let scrollTimeout;
window.addEventListener('scroll', function() {
  if (!scrollTimeout) {
    scrollTimeout = setTimeout(function() {
      handleHeaderScroll();
      scrollTimeout = null;
    }, 10);
  }
});
