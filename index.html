<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=420, initial-scale=1.0">
  <title>מודעות הצפון - הלוח הדיגיטלי של הצפון</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="logo-modaot-hatzafon.svg">
  <style>
    body { font-family: 'Heebo', Arial, sans-serif; background: #f7fafc; margin: 0; }
    header {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
  box-shadow: 0 2px 8px #e0e0e0;
  padding: 10px 0 8px 0;
  position: sticky;
  top: 0;
  z-index: 1000;
  position: relative;
}
    .logo { width: 220px; margin-bottom: 10px; }
    .subtitle { color: #333; font-size: 18px; margin-bottom: 0; }

    .ads-board { flex: 1; display: flex; flex-direction: column; gap: 24px; }
    /* עיצוב תיבת הפרשה והתאריכים */
    .parsha-date-box {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    
    .parsha-name {
      font-size: 24px;
      color: #2c3e50;
      font-weight: bold;
      margin-bottom: 10px;
      line-height: 1.3;
    }
    
    .dates-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      color: #555;
    }
    
    .hebrew-date {
      direction: rtl;
    }
    
    .divider {
      color: #bdc3c7;
      font-weight: 300;
    }
    
    .gregorian-date {
      font-family: Arial, sans-serif;
      letter-spacing: 0.5px;
    }
    
    @media (max-width: 600px) {
      .parsha-name {
        font-size: 20px;
      }
      
      .dates-container {
        flex-direction: column;
        gap: 5px;
      }
      
      .divider {
        display: none;
      }
    }
    .filters { margin-bottom: 18px; }
    .filters select { font-size: 15px; padding: 4px 8px; border-radius: 6px; border: 1px solid #bbb; }
    .ad-card {
      background: #fff; border-radius: 16px; box-shadow: 0 2px 12px #e0e0e0;
      padding: 18px 18px 12px 18px; display: flex; flex-direction: column; gap: 10px;
      width: 100%; max-width: 800px; margin: 0 auto;
    }
    .ad-card .ad-image { width: 100%; border-radius: 12px; max-height: 350px; object-fit: contain; background: #f0f0f0; }
    .ad-card .ad-content { font-size: 17px; color: #222; }
    .ad-card .ad-dynamic { margin-top: 6px; font-size: 15px; color: #0099cc; }
    .ad-card .ad-actions {
      display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
    }
    .ad-card .ad-btn {
      border: none; border-radius: 8px; padding: 8px 14px;
      font-size: 15px; cursor: pointer; transition: background 0.2s;
      background: #0099cc; color: #fff; font-weight: bold;
      display: flex; align-items: center; gap: 6px;
    }
    .ad-card .ad-btn.whatsapp { background: #25d366; }
    .ad-card .ad-btn.link { background: #ffd600; color: #333; }
    .ad-card .ad-btn.email { background: #ff7043; }
    .a4-image {
  width: 794px !important; /* רוחב A4 ב-px */
  aspect-ratio: 210/297;
  max-width: 100vw !important;
  max-height: 100vh !important;
  height: auto !important;
  display: block;
  margin: 0 auto;
  object-fit: contain;
  background: #f0f0f0;
  border-radius: 12px;
  box-shadow: 0 2px 16px #e0e0e0;
}
    .ads-board {
  overflow-y: auto;
  max-height: none;
  min-height: 100vh;
  padding-bottom: 40px;
}
    @media (max-width: 820px) {
      .a4-image {
        width: 100vw !important;
        height: auto !important;
        max-width: 100vw !important;
        max-height: 65vh !important;
      }
      .ads-board {
        max-height: 70vh;
      }
    }
    .nav-btn {
      display: inline-block; background: #0099cc; color: #fff; font-weight: bold;
      padding: 8px 18px; border-radius: 8px; text-decoration: none; font-size: 16px;
      transition: background 0.2s, color 0.2s;
      position: relative;
    }
    .nav-btn:hover { background: #ffd600; color: #222; }
    
    #openFilterBarBtn {
      position: relative;
    }
    
    /* וידוא שתפריט הסינון מופיע מתחת לכפתור */
    #openFilterBarBtn + .filter-bar {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
    }
    .badge {
      background-color: #ff5722;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 12px;
      margin-right: 5px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-btn {
      float: left;
      cursor: pointer;
      font-size: 20px;
    }
    @media (max-width: 900px) {
      .main-nav { flex-wrap: wrap; gap: 7px; }
      .nav-btn { font-size: 15px; padding: 7px 10px; }
    }
  </style>
</head>
<body>
  <!-- Scripts will be loaded at the bottom of the body -->
  <header>
  <div class="header-row">
    <nav class="main-nav">
      <button id="openFilterBarBtn" class="nav-btn" title="סינון מתקדם">
        <span class="filter-icon">🔍</span> סינון מתקדם
        <span id="selectedCityBadge" class="badge" style="display: none;"></span>
      </button>
      <a class="nav-btn" href="advertiser.html">➕ העלאת מודעה</a>
      <a class="nav-btn" href="my-ads.html">📋 המודעות שלי</a>
      <a class="nav-btn" href="admin.html">⚙️ ממשק ניהול</a>
    </nav>
  </div>
  
  <!-- תפריט סינון מתקדם מתחת לכפתור -->
  <div id="filterBar" class="filter-bar" style="display: none;"></div>
  
  <style>
    .logo-container {
      display: flex;
      justify-content: center;
      padding: 10px 0;
      background: #f7fafc; /* צבע רקע אפור בהיר כמו רקע האתר */
      width: 100%;
    }
    
    .site-logo {
      max-width: 600px;
      height: auto;
      display: block;
    }
    
    .header-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 0 16px;
      min-height: 64px;
    }
    .logo {
      width: 160px;
      margin-bottom: 0;
      margin-left: 12px;
    }
    .main-nav {
      display: flex;
      flex-direction: row;
      gap: 12px;
    }
    .subtitle {
      text-align: center;
      font-size: 18px;
      color: #333;
      margin-bottom: 0;
      margin-top: 2px;
    }
    @media (max-width: 600px) {
      .header-row { flex-direction: column; gap: 8px; padding: 0 4px; }
      .logo { width: 120px; }
      .main-nav { flex-direction: column; gap: 6px; }
      .subtitle { font-size: 15px; }
      /* .filter-bar - הסרנו את העיצוב כאן כדי למנוע סתירה מול style.css */
      
      .filters-container {
        gap: 6px;
      }
      
      .filter-btn {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .neighborhoods-menu {
        min-width: 180px;
        max-height: 150px;
        right: -10px;
      }
      
      .neighborhood-label {
        font-size: 12px;
        padding: 5px 8px;
      }
    }

    /* סגנונות לסרגל הסינון המתקדם */
    .filter-bar-overlay {
      display: none;
    }

    

    .close-filter-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #ff5722;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .close-filter-btn:hover {
      background: #d84315;
    }

    .filter-bar h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      text-align: center;
      color: #333;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .apply-filter-btn, .clear-filter-btn {
      background: #0099cc;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }

    .apply-filter-btn:hover {
      background: #007a99;
    }

    .clear-filter-btn {
      background: #ff5722;
    }

    .clear-filter-btn:hover {
      background: #d84315;
    }

    .filters-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      margin-bottom: 15px;
      align-items: flex-start;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .filter-btn {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #e9ecef;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .filter-btn:hover {
      background: #dee2e6;
    }

    .filter-btn.selected {
      background: #0099cc;
      color: white;
      border-color: #0099cc;
    }

    .filter-btn {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #495057;
      transition: all 0.2s ease;
      white-space: nowrap;
      user-select: none;
      padding: 8px 12px;
      min-width: fit-content;
    }

    .filter-btn input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #007bff;
      cursor: pointer;
    }

    .filter-btn .dropdown-arrow {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .city-dropdown {
      position: relative;
    }

    .city-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .neighborhoods-menu {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 200px;
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-top: 5px;
      padding: 8px;
      /* display: none; הוסר - שלוט רק מה-style.css */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      min-height: 0;
      max-height: 80vh;
      height: auto;
      overflow-y: auto;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      border: 2px solid #0099cc;
    }

    .filter-bar {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 1200px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 15px;
      direction: rtl;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      overflow: visible;
      margin-top: 5px;
    }

    .city-dropdown {
      position: relative;
    }

    .city-dropdown.open .neighborhoods-menu {
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .neighborhood-item {
      padding: 0;
    }

    .neighborhood-label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px 0;
      font-size: 13px;
      color: #495057;
      border-radius: 4px;
      background: #f8f9fa;
      border: 1px solid transparent;
      font-weight: 500;
    }

    .neighborhood-label:hover {
      background: #e9ecef;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .neighborhood-label.selected {
      background: #0099cc;
      color: white;
      border-color: #0099cc;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 153, 204, 0.3);
    }



    .neighborhood-label input[type="checkbox"] {
      margin: 0;
      width: 16px;
      height: 16px;
      accent-color: #0099cc;
      cursor: pointer;
    }

    /* וידוא שתפריט השכונות מופיע מעל הכל */
    .filter-bar * {
      overflow: visible;
    }

    .apply-filter-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 10px;
    }

    .apply-filter-btn:hover {
      background: #218838;
    }

    .filter-buttons-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .clear-filter-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .clear-filter-btn:hover {
      background: #c82333;
    }

    .close-filter-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s ease;
    }

    .close-filter-btn:hover {
      background: #e9ecef;
      color: #333;
    }

    /* עיצוב רספונסיבי */
    @media (max-width: 768px) {
      .filter-bar {
        min-width: 95vw;
        max-width: 95vw;
        padding: 15px;
        border-radius: 8px;
      }

      .filters-container {
        gap: 8px;
      }

      .filter-btn {
        padding: 8px 12px;
        font-size: 13px;
      }

      .neighborhoods-menu {
        min-width: 180px;
      }

      .neighborhood-label {
        padding: 8px 10px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      /* .filter-bar - הסרנו את העיצוב כאן כדי למנוע סתירה מול style.css */

      .filters-container {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-btn {
        justify-content: space-between;
      }

      .neighborhoods-menu {
        position: static;
        box-shadow: none;
        border: none;
        border-top: 1px solid #dee2e6;
        border-radius: 0;
        margin-top: 0;
      }
    }
  </style>
</header>



  <!-- לוגו האתר -->
  <div class="logo-container">
    <img src="mod.gif" alt="לוגו האתר" class="site-logo" id="animatedLogo">
  </div>
  
  <script>
    // קוד פשוט להצגת GIF ואז החלפה לתמונה סטטית
    document.addEventListener('DOMContentLoaded', function() {
      const logo = document.getElementById('animatedLogo');
      
      // החלף את ה-GIF בתמונה הסטטית אחרי 3 שניות
      setTimeout(() => {
        logo.src = 'mod.png';
        logo.alt = 'לוגו האתר';
      }, 3000); // 3000 מילישניות = 3 שניות
    });
  </script>

  <div class="main-layout">
    <!-- סרגל סינון מתקדם -->
    <div id="filterBarOverlay" class="filter-bar-overlay"></div>
    
    <nav class="categories-menu">
      <ul id="categoriesMenuUl"></ul>
    </nav>
    <main class="ads-board" id="adsBoard">
      <!-- תיבת תצוגה לפרשה ותאריכים - אינטראקטיבית -->
      <div class="parsha-date-box" id="parshaDateBox" style="position: relative;">
        <!-- כפתורי ניווט בין גיליונות -->
        <div class="issue-navigation" id="issueNavigation" style="display: none; margin-bottom: 15px; text-align: center;">
          <button id="prevIssueBtn" onclick="navigateIssue(-1)" style="background: #0099cc; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin: 0 5px; font-size: 14px;">◀ קודם</button>
          <span id="issueCounter" style="margin: 0 15px; font-size: 14px; color: #666;">1 מתוך 1</span>
          <button id="nextIssueBtn" onclick="navigateIssue(1)" style="background: #0099cc; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin: 0 5px; font-size: 14px;">הבא ▶</button>
        </div>
        
        <div class="parsha-name" id="parshaName">פרשת מטות-מסעי</div>
        <div class="dates-container">
          <span class="hebrew-date" id="hebrewDate">כ"ד בתמוז תשפ"ה</span>
          <span class="divider">|</span>
          <span class="gregorian-date" id="gregorianDate">20.07.2025</span>
        </div>
        
        <!-- תפריט בחירת גיליונות (נסתר כברירת מחדל) -->
        <div class="issues-dropdown" id="issuesDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 300px; overflow-y: auto;">
          <!-- גיליונות יופיעו כאן -->
        </div>
      </div>

      <!-- אפשר להוסיף כאן מודעות נוספות -->
    </main>
  </div>
  
  <!-- Load scripts here, after the HTML is parsed but before renderAds is called -->
  <script src="categories-data.js"></script>
  <script src="cities-data.js"></script>
  <script src="filter-bar.js"></script>
  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js"></script>
  
  <script>
    // פונקציה לטעינת הגיליון השבועי הנוכחי
    function loadCurrentWeeklyIssue() {
  const savedIssues = localStorage.getItem('weeklyIssues');
  const ads = JSON.parse(localStorage.getItem('ads')||'[]');
  if (savedIssues) {
    try {
      const issues = JSON.parse(savedIssues);
      // סנן רק גיליונות פעילים
      const activeIssues = issues.filter(issue => issue.isActive);
      
      if (activeIssues.length > 0) {
        // בדוק אם יש גיליון שנבחר בעבר
        let selectedIssueId = localStorage.getItem('selectedIssueId');
        let selectedIssue = selectedIssueId ? activeIssues.find(issue => issue.id == selectedIssueId) : null;
        if (!selectedIssue) {
          selectedIssue = activeIssues[0];
          localStorage.setItem('selectedIssueId', selectedIssue.id);
        }
        displayIssue(selectedIssue);
        // הוסף ממשק מעבר בין גיליונות
        updateIssueNavigation(activeIssues, selectedIssue);
        // סנן מודעות לפי הגיליון הנבחר
        let filteredAds = ads.filter(ad => ad.issueId == selectedIssue.id);
        // תמיכה בסינון עיר/שכונה קיים
        const selectedCity = localStorage.getItem('selectedCity');
        if (selectedCity) {
          filteredAds = filteredAds.filter(ad => ad.city === selectedCity);
        }
        renderAds(filteredAds);
        if (filteredAds.length === 0) {
          // ודא שתיבת הגיליון parshaDateBox לא מוסתרת
          const board = document.getElementById('adsBoard');
          // מחק הודעות קודמות אם יש
          let noAdsMsg = document.getElementById('noAdsMsg');
          if (noAdsMsg) noAdsMsg.remove();
          // הוסף הודעה מתחת לתיבת הגיליון
          noAdsMsg = document.createElement('div');
          noAdsMsg.id = 'noAdsMsg';
          noAdsMsg.style = 'text-align:center;color:#888;font-size:22px;margin:44px 0;';
          noAdsMsg.innerText = 'אין מודעות בגיליון זה';
          const parshaBox = document.getElementById('parshaDateBox');
          if (parshaBox && parshaBox.parentNode) {
            parshaBox.parentNode.insertBefore(noAdsMsg, parshaBox.nextSibling);
          } else {
            board.appendChild(noAdsMsg);
          }
        } else {
          // הסר הודעת אין מודעות אם יש
          let noAdsMsg = document.getElementById('noAdsMsg');
          if (noAdsMsg) noAdsMsg.remove();
        }
      } else {
        // אין גיליונות פעילים
        const board = document.getElementById('adsBoard');
        board.innerHTML = '<div style="text-align:center;color:#888;font-size:22px;margin:44px 0;">אין גיליונות פעילים כרגע</div>';
        document.getElementById('parshaDateBox').style.display = 'none';
      }
    } catch(e) {
      console.log('שגיאה בטעינת הגיליון השבועי:', e);
    }
  }
}

    function displayIssue(issue) {
      document.getElementById('parshaName').textContent = issue.parshaName;
      document.getElementById('hebrewDate').textContent = issue.hebrewDate;
      
      // עיצוב התאריך הלועזי
      const gregorianDate = new Date(issue.gregorianDate);
      const formattedDate = gregorianDate.toLocaleDateString('he-IL');
      document.getElementById('gregorianDate').textContent = formattedDate;
    }

    // פונקציה לעדכון ממשק הניווט בין גיליונות
    function updateIssueNavigation(activeIssues, selectedIssue) {
      const navigation = document.getElementById('issueNavigation');
      const counter = document.getElementById('issueCounter');
      const prevBtn = document.getElementById('prevIssueBtn');
      const nextBtn = document.getElementById('nextIssueBtn');
      
      if (activeIssues.length > 1) {
        navigation.style.display = 'block';
        const currentIndex = activeIssues.findIndex(issue => issue.id === selectedIssue.id);
        counter.textContent = `${currentIndex + 1} מתוך ${activeIssues.length}`;
        
        // עדכון מצב הכפתורים
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === activeIssues.length - 1;
        
        // עיצוב כפתורים מכובים
        prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
        nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
        prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
        nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
      } else {
        navigation.style.display = 'none';
      }
    }

    // פונקציה לניווט בין גיליונות
    function navigateIssue(direction) {
      const savedIssues = localStorage.getItem('weeklyIssues');
      if (!savedIssues) return;
      
      try {
        const issues = JSON.parse(savedIssues);
        const activeIssues = issues.filter(issue => issue.isActive);
        const selectedIssueId = localStorage.getItem('selectedIssueId');
        const currentIndex = activeIssues.findIndex(issue => issue.id == selectedIssueId);
        
        let newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= activeIssues.length) newIndex = activeIssues.length - 1;
        
        if (newIndex !== currentIndex) {
          const newIssue = activeIssues[newIndex];
          localStorage.setItem('selectedIssueId', newIssue.id);
          displayIssue(newIssue);
          updateIssueNavigation(activeIssues, newIssue);
          
          // טען מודעות של הגיליון החדש
          const ads = JSON.parse(localStorage.getItem('ads')||'[]');
          let filteredAds = ads.filter(ad => ad.issueId == newIssue.id);
          const selectedCity = localStorage.getItem('selectedCity');
          if (selectedCity) {
            filteredAds = filteredAds.filter(ad => ad.city === selectedCity);
          }
          renderAds(filteredAds);
          
          if (filteredAds.length === 0) {
            const board = document.getElementById('adsBoard');
            let noAdsMsg = document.getElementById('noAdsMsg');
            if (noAdsMsg) noAdsMsg.remove();
            noAdsMsg = document.createElement('div');
            noAdsMsg.id = 'noAdsMsg';
            noAdsMsg.style = 'text-align:center;color:#888;font-size:22px;margin:44px 0;';
            noAdsMsg.innerText = 'אין מודעות בגיליון זה';
            const parshaBox = document.getElementById('parshaDateBox');
            if (parshaBox && parshaBox.parentNode) {
              parshaBox.parentNode.insertBefore(noAdsMsg, parshaBox.nextSibling);
            } else {
              board.appendChild(noAdsMsg);
            }
          } else {
            let noAdsMsg = document.getElementById('noAdsMsg');
            if (noAdsMsg) noAdsMsg.remove();
          }
        }
      } catch(e) {
        console.log('שגיאה בניווט בין גיליונות:', e);
      }
    }

    function toggleIssuesMenu() {
      const dropdown = document.getElementById('issuesDropdown');
      const isVisible = dropdown.style.display !== 'none';
      
      if (isVisible) {
        dropdown.style.display = 'none';
      } else {
        loadIssuesDropdown();
        dropdown.style.display = 'block';
      }
    }

    function loadIssuesDropdown() {
      const savedIssues = localStorage.getItem('weeklyIssues');
      const dropdown = document.getElementById('issuesDropdown');
      
      if (!savedIssues) {
        dropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">אין גיליונות זמינים</div>';
        return;
      }
      
      try {
        const issues = JSON.parse(savedIssues);
        // סנן רק גיליונות פעילים
        const activeIssues = issues.filter(issue => issue.isActive);
        dropdown.innerHTML = '';
        
        if (activeIssues.length === 0) {
          dropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">אין גיליונות פעילים</div>';
          return;
        }
        
        activeIssues.forEach((issue, idx) => {
          const issueItem = document.createElement('div');
          issueItem.style.cssText = `
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            ${issue.isActive ? 'background: #f0f8ff; border-right: 3px solid #0099cc;' : ''}
          `;
          
          issueItem.innerHTML = `
            <div style="font-weight: bold; color: ${issue.isActive ? '#0099cc' : '#333'}; margin-bottom: 4px;">
              ${issue.parshaName} ${issue.isActive ? '(פעיל)' : ''}
            </div>
            <div style="font-size: 12px; color: #666;">
              ${issue.hebrewDate} | ${new Date(issue.gregorianDate).toLocaleDateString('he-IL')}
            </div>
          `;
          
          issueItem.onmouseover = () => {
            if (!issue.isActive) issueItem.style.background = '#f8f9fa';
          };
          issueItem.onmouseout = () => {
            if (!issue.isActive) issueItem.style.background = '';
          };
          
          issueItem.onclick = (e) => {
            e.stopPropagation();
            selectActiveIssue(issue.id);
          };
          
          dropdown.appendChild(issueItem);
        });
        
        // הוספת קישור לממשק הניהול
        const adminLink = document.createElement('div');
        adminLink.style.cssText = `
          padding: 12px 15px;
          background: #0099cc;
          color: white;
          text-align: center;
          cursor: pointer;
          font-weight: bold;
          border-radius: 0 0 8px 8px;
        `;
        adminLink.textContent = '⚙️ ניהול גיליונות';
        adminLink.onclick = (e) => {
          e.stopPropagation();
          window.location.href = 'admin.html';
        };
        dropdown.appendChild(adminLink);
        
      } catch(e) {
        dropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">שגיאה בטעינת הגיליונות</div>';
      }
    }

    function selectActiveIssue(issueId) {
      const savedIssues = localStorage.getItem('weeklyIssues');
      if (!savedIssues) return;
      
      try {
        const issues = JSON.parse(savedIssues);
        const activeIssues = issues.filter(issue => issue.isActive);
        const selectedIssue = activeIssues.find(issue => issue.id == issueId);
        
        if (selectedIssue) {
          displayIssue(selectedIssue);
          updateIssueNavigation(activeIssues, selectedIssue);
          document.getElementById('issuesDropdown').style.display = 'none';
          // שמור מזהה הגיליון הנבחר ב-localStorage
          localStorage.setItem('selectedIssueId', selectedIssue.id);
          // טען את כל המודעות
          let ads = JSON.parse(localStorage.getItem('ads')||'[]');
          // סנן לפי מזהה גיליון
          let filteredAds = ads.filter(ad => ad.issueId == selectedIssue.id);
          // תמיכה בסינון עיר/שכונה קיים
          const selectedCity = localStorage.getItem('selectedCity');
          if (selectedCity) {
            filteredAds = filteredAds.filter(ad => ad.city === selectedCity);
          }
          renderAds(filteredAds);
          // אם אין מודעות - הצג הודעה מתאימה
          if (filteredAds.length === 0) {
            const board = document.getElementById('adsBoard');
            let noAdsMsg = document.getElementById('noAdsMsg');
            if (noAdsMsg) noAdsMsg.remove();
            noAdsMsg = document.createElement('div');
            noAdsMsg.id = 'noAdsMsg';
            noAdsMsg.style = 'text-align:center;color:#888;font-size:22px;margin:44px 0;';
            noAdsMsg.innerText = 'אין מודעות בגיליון זה';
            const parshaBox = document.getElementById('parshaDateBox');
            if (parshaBox && parshaBox.parentNode) {
              parshaBox.parentNode.insertBefore(noAdsMsg, parshaBox.nextSibling);
            } else {
              board.appendChild(noAdsMsg);
            }
          } else {
            let noAdsMsg = document.getElementById('noAdsMsg');
            if (noAdsMsg) noAdsMsg.remove();
          }
        }
      } catch(e) {
        console.log('שגיאה בבחירת גיליון:', e);
      }
    }

    // סגירת התפריט בלחיצה מחוץ
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('issuesDropdown');
      const parshaBox = document.getElementById('parshaDateBox');
      
      if (dropdown && parshaBox && !parshaBox.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // פונקציה לעדכון תפריט הקטגוריות בהתאם למודעות המסוננות
    function updateCategoriesMenu(adsByCat, categoriesSource) {
      const menuUl = document.getElementById('categoriesMenuUl');
      if (!menuUl) return;
      
      menuUl.innerHTML = '';
      
      // הוספת קטגוריות עם מודעות
      categoriesSource.forEach(cat => {
        const catName = typeof cat === 'object' ? cat.name : cat;
        if (adsByCat[catName] && adsByCat[catName].length > 0) {
          const catData = window.categoriesData?.find(c => c.name === catName) || {};
          const li = document.createElement('li');
          li.innerHTML = `<a href="#cat-${catName.replace(/\s+/g, '-')}">${catData.icon || '📌'} ${catName}</a>`;
          li.style.padding = '10px 8px';
          li.style.marginBottom = '6px';
          li.style.borderRadius = '8px';
          li.style.cursor = 'pointer';
          li.style.display = 'flex';
          li.style.alignItems = 'center';
          li.style.transition = 'background 0.2s, color 0.2s';
          li.dataset.cat = catName;
          li.dataset.bg = (catData.color || '#f0f0f0') + '22';
          li.dataset.color = catData.color || '#333';
          menuUl.appendChild(li);
        }
      });
      
      // הוספת קטגוריית "ללא קטגוריה" אם יש מודעות כאלה
      if (adsByCat['ללא קטגוריה'] && adsByCat['ללא קטגוריה'].length) {
        const li = document.createElement('li');
        li.innerHTML = `<a href="#cat-ללא-קטגוריה">📌 ללא קטגוריה</a>`;
        li.style.padding = '10px 8px';
        li.style.marginBottom = '6px';
        li.style.borderRadius = '8px';
        li.style.cursor = 'pointer';
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.transition = 'background 0.2s, color 0.2s';
        menuUl.appendChild(li);
      }
    }

    // טען מודעות מה-localStorage, סנן לפי עיר נבחרת והצג אותן
    function renderAds(filteredAds) {
      let ads = Array.isArray(filteredAds) ? filteredAds : JSON.parse(localStorage.getItem('ads')||'[]');
      // אם קיבלנו מודעות מסוננות, נשתמש בהן
      // אחרת - מציגים את כל המודעות (ללא סינון ברירת מחדל)
      // (הסרת סינון לפי selectedCity)
      const board = document.getElementById('adsBoard');
      const demo = document.getElementById('demoAd');
      // Remove old ads
      board.querySelectorAll('.ad-card:not(.demo-ad), .ads-category-title').forEach(e => e.remove());
      if (ads.length > 0 && demo) demo.style.display = 'none';
      else if (demo) demo.style.display = '';
      
      // Get categories in the right order
      const categoriesSource = (function() {
        const savedOrder = localStorage.getItem('categoriesOrder');
        if (savedOrder) {
          try { 
            return JSON.parse(savedOrder); 
          } catch(e) {
            console.error('Error parsing categories order:', e);
            return window.categoriesData || [];
          }
        }
        return window.categoriesData || [];
      })();
      
      if (!categoriesSource || !categoriesSource.length) return;
  // קיבוץ מודעות לפי קטגוריה
  const adsByCat = {};
  ads.forEach(ad => {
    const cat = ad.category || 'ללא קטגוריה';
    if (!adsByCat[cat]) adsByCat[cat] = [];
    adsByCat[cat].push(ad);
  });

  // עדכון תפריט הקטגוריות (ul#categoriesMenuUl) בהתאם למודעות המסוננות
  updateCategoriesMenu(adsByCat, categoriesSource);

  // עבור כל קטגוריה לפי הסדר
  categoriesSource.forEach(cat => {
    const catAds = adsByCat[cat.name];
    if (!catAds || !catAds.length) return;
    // כותרת קטגוריה
    const title = document.createElement('div');
    title.className = 'ads-category-title';
    title.id = 'cat-' + cat.name.replace(/\s+/g, '-');
    title.style = `font-size:22px;font-weight:bold;margin:28px 0 10px 0;display:flex;align-items:center;gap:8px;color:${cat.color}`;
    title.innerHTML = `<span style='font-size:28px;'>${cat.icon||''}</span><span>${cat.name}</span>`;
    board.appendChild(title);
    // כל המודעות של הקטגוריה
    catAds.slice().reverse().forEach(ad => {
      const el = document.createElement('article');
      el.className = 'ad-card';
      let imgHtml = ad.img ? `<img class="ad-image a4-image" src="${ad.img}" alt="מודעה">` : '';
      let dynamicHtml = '';
      if(ad.dynamic && ad.dynamic.length) {
        dynamicHtml = ad.dynamic.map(d=>`${d.field}: ${d.value}`).join(' | ');
      }
      el.innerHTML = `
        ${imgHtml}
        <div class="ad-content">${ad.content || ad.title || ''}</div>

        <div class="ad-dynamic">${dynamicHtml}</div>
        <div class="ad-sidebar">
  <button class="sidebar-icon phone" title="התקשר" onclick="${ad.phone ? `window.open('tel:${ad.phone}')` : ''}">
  <span aria-hidden="true">
    <!-- טלפון חוגה קלאסי -->
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" style="display:block" xmlns="http://www.w3.org/2000/svg">
  <!-- שפופרת ארוכה וברורה -->
  <path d="M6 10 Q16 3 26 10" stroke="#3e2d12" stroke-width="3" fill="none"/>
  <rect x="4" y="9" width="4" height="3" rx="1.5" fill="#e3d6b2" stroke="#3e2d12" stroke-width="1.2"/>
  <rect x="24" y="9" width="4" height="3" rx="1.5" fill="#e3d6b2" stroke="#3e2d12" stroke-width="1.2"/>
  <!-- גוף מובלט -->
  <circle cx="16" cy="21" r="8.5" fill="#f9f6e2" stroke="#3e2d12" stroke-width="2.2"/>
  <!-- חוגה עם סימנים -->
  <circle cx="16" cy="21" r="4.5" fill="#e3d6b2" stroke="#3e2d12" stroke-width="1.4"/>
  <!-- סימנים בחוגה -->
  <circle cx="16" cy="18.5" r="0.7" fill="#3e2d12"/>
  <circle cx="13.8" cy="19.5" r="0.7" fill="#3e2d12"/>
  <circle cx="13.2" cy="22" r="0.7" fill="#3e2d12"/>
  <circle cx="14.5" cy="24" r="0.7" fill="#3e2d12"/>
  <circle cx="17.5" cy="24" r="0.7" fill="#3e2d12"/>
  <circle cx="18.8" cy="22" r="0.7" fill="#3e2d12"/>
  <circle cx="18.2" cy="19.5" r="0.7" fill="#3e2d12"/>
  <!-- מרכז חוגה -->
  <circle cx="16" cy="21" r="1" fill="#3e2d12"/>
</svg>
  </span>
</button>
<button class="sidebar-icon message" title="שלח הודעה" onclick="${ad.email ? `window.location.href='mailto:${ad.email}'` : ''}">
  <span aria-hidden="true">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" style="display:block" xmlns="http://www.w3.org/2000/svg">
      <g stroke="#3e2d12" stroke-width="2" fill="#f9f6e2">
        <rect x="6" y="8" width="20" height="16" rx="3" fill="#f9f6e2"/>
        <polyline points="8,10 16,18 24,10" fill="none"/>
      </g>
    </svg>
  </span>
</button>
<button class="sidebar-icon link" title="לאתר" onclick="if('${ad.link}') window.open('${ad.link}','_blank')">
  <span aria-hidden="true">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" style="display:block" xmlns="http://www.w3.org/2000/svg">
      <g stroke="#3e2d12" stroke-width="2" fill="none">
        <circle cx="16" cy="16" r="11" fill="#f9f6e2"/>
        <ellipse cx="16" cy="16" rx="6" ry="11" fill="none"/>
        <ellipse cx="16" cy="16" rx="11" ry="6" fill="none"/>
      </g>
    </svg>
  </span>
</button>
<button class="sidebar-icon location" title="מיקום" onclick="alert('עיר: ${ad.city || ''}${ad.neighborhood ? ' | שכונה: ' + ad.neighborhood : ''}')">
  <span aria-hidden="true">
    <!-- בועת מיקום קלאסית -->
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" style="display:block" xmlns="http://www.w3.org/2000/svg">
      <g stroke="#3e2d12" stroke-width="2" fill="#f9f6e2">
        <path d="M16 5c5 0 9 4 9 9 0 7.5-9 13-9 13s-9-5.5-9-13c0-5 4-9 9-9z"/>
        <circle cx="16" cy="14" r="3.2" fill="#e3d6b2" stroke="#3e2d12" stroke-width="1.2"/>
      </g>
    </svg>
  </span>
</button>
</div>
      `;
      board.appendChild(el);
    });
  });
  // מודעות ללא קטגוריה (אם יש)
  if (adsByCat['ללא קטגוריה']) {
    const title = document.createElement('div');
    title.className = 'ads-category-title';
    title.style = 'font-size:22px;font-weight:bold;margin:28px 0 10px 0;display:flex;align-items:center;gap:8px;color:#888';
    title.innerHTML = `<span>ללא קטגוריה</span>`;
    board.appendChild(title);
    adsByCat['ללא קטגוריה'].slice().reverse().forEach(ad => {
      const el = document.createElement('article');
      el.className = 'ad-card';
      let imgHtml = ad.img ? `<img class=\"ad-image a4-image\" src=\"${ad.img}\" alt=\"מודעה\">` : '';
      let dynamicHtml = '';
      if(ad.dynamic && ad.dynamic.length) {
        dynamicHtml = ad.dynamic.map(d=>`${d.field}: ${d.value}`).join(' | ');
      }
      el.innerHTML = `
        ${imgHtml}
        <div class="ad-content">${ad.content || ad.title || ''}</div>
        <div class="ad-dynamic">${dynamicHtml}</div>
        <div class="ad-sidebar">
          <button class="sidebar-icon phone" title="התקשר" onclick="${ad.phone ? `window.open('tel:${ad.phone}')` : ''}"><span>📞</span></button>
          <button class="sidebar-icon message" title="שלח הודעה" onclick="${ad.email ? `window.location.href='mailto:${ad.email}'` : ''}"><span>✉️</span></button>
          <button class="sidebar-icon link" title="לאתר" onclick="${ad.link ? `window.open('${ad.link}','_blank')` : ''}"><span>🔗</span></button>
          <button class="sidebar-icon location" title="מיקום" onclick="alert('עיר: ${ad.city || ''}${ad.neighborhood ? ' | שכונה: ' + ad.neighborhood : ''}')"><span>📍</span></button>
        </div>
      `;
      board.appendChild(el);
    });
  }
}
window.addEventListener('DOMContentLoaded', renderAds);
    </script>
  </div>
  


<script>
// רינדור דינמי של תפריט הקטגוריות - שם + אייקון + צבע רקע ל-active
function renderCategoriesMenu() {
  const menu = document.getElementById('categoriesMenuUl');
  if (!menu) return;
  
  // קבל את סדר הקטגוריות מה-localStorage או השתמש בסדר ברירת המחדל
  const savedOrder = localStorage.getItem('categoriesOrder');
  let categoriesOrder = [];
  
  if (savedOrder) {
    try {
      categoriesOrder = JSON.parse(savedOrder);
    } catch (e) {
      console.error('Error parsing categories order:', e);
    }
  }
  
  // Get all ads to filter categories by selected city
  const allAds = JSON.parse(localStorage.getItem('ads') || '[]');
  const selectedCity = localStorage.getItem('selectedCity');
  
  // Filter ads by selected city if any
  const filteredAds = selectedCity 
    ? allAds.filter(ad => ad.city === selectedCity)
    : allAds;
    
  // Get unique categories from filtered ads
  const activeCategories = [...new Set(filteredAds.map(ad => ad.category))];
  
  menu.innerHTML = ''; // Clear existing menu
  
  // Get all categories in the desired order
  const categoriesSource = (() => {
    // First, get all visible categories from categoriesData
    const visibleCategories = window.categoriesData
      .filter(cat => cat.visible !== false)
      .map(cat => cat.name);
    
    // If we have a saved order, use it to sort the visible categories
    if (savedOrder) {
      try {
        const order = JSON.parse(savedOrder);
        // Filter and sort based on saved order, but only include active categories
        return order.filter(catName => 
          visibleCategories.includes(catName) && 
          activeCategories.includes(catName)
        );
      } catch (e) {
        console.error('Error parsing categories order:', e);
      }
    }
    // If no saved order or error, use default order from categoriesData
    // but only include categories that have ads in the current filter
    return visibleCategories.filter(catName => 
      activeCategories.includes(catName)
    );
  })();



  // הוספת הקטגוריות לתפריט
  let first = true;
  categoriesSource.forEach(catName => {
    // הצג רק קטגוריות שיש להן מודעות בפועל
    if (!adsByCat[catName] || !adsByCat[catName].length) return;
    const cat = window.categoriesData.find(c => c.name === catName) || {};

    
    const li = document.createElement('li');
    li.innerHTML = `<span style='font-size:20px;margin-left:6px;'>${cat.icon||'📌'}</span><span>${catName}</span>`;
    li.style.padding = '10px 8px';
    li.style.marginBottom = '6px';
    li.style.borderRadius = '8px';
    li.style.cursor = 'pointer';
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.transition = 'background 0.2s, color 0.2s';
    li.dataset.cat = catName;
    li.dataset.bg = cat.color+'22';
    li.dataset.color = cat.color;
    
    // סגנון לקטגוריה הפעילה
    if (first) {
      li.classList.add('active');
      li.style.background = cat.color+'22';
      li.style.color = cat.color;
      li.style.fontWeight = 'bold';
      first = false;
    }
    
    // טיפול בלחיצה על קטגוריה
    li.onclick = function() {
      ul.querySelectorAll('li').forEach(el => {
        el.classList.remove('active');
        el.style.background = '';
        el.style.color = '';
        el.style.fontWeight = '';
      });
      li.classList.add('active');
      li.style.background = cat.color+'22';
      li.style.color = cat.color;
      li.style.fontWeight = 'bold';
      // גלילה אוטומטית לכותרת הקטגוריה
      const targetId = 'cat-' + cat.name.replace(/\s+/g, '-');
      const target = document.getElementById(targetId);
      if(target) {
        const offset = 110; // גובה הסרגל העליון
        const top = target.getBoundingClientRect().top + window.scrollY - offset;
        window.scrollTo({top, behavior:'smooth'});
      }
    };
    ul.appendChild(li);
  });
}
document.addEventListener('DOMContentLoaded', function() {
  loadCurrentWeeklyIssue();
  renderCategoriesMenu();
});
// רענון התפריט בכל שינוי במודעות
window.addEventListener('storage', renderCategoriesMenu);

// הדגשה אוטומטית של קטגוריה בתפריט הדביק לפי גלילה
function updateActiveCategoryOnScroll() {
  const titles = Array.from(document.querySelectorAll('.ads-category-title'));
  const menuLis = Array.from(document.querySelectorAll('#categoriesMenuUl li'));
  if (!titles.length || !menuLis.length) return;
  let activeIdx = 0;
  const offset = 120; // כוון לפי גובה הסרגל העליון
  titles.forEach((title, i) => {
    const rect = title.getBoundingClientRect();
    if (rect.top - offset < 0) activeIdx = i;
  });
  menuLis.forEach((li, i) => {
    if (i === activeIdx) {
      li.classList.add('active');
      li.style.background = li.dataset.bg;
      li.style.color = li.dataset.color;
      li.style.fontWeight = 'bold';
    } else {
      li.classList.remove('active');
      li.style.background = '';
      li.style.color = '';
      li.style.fontWeight = '';
    }
  });
}
window.addEventListener('scroll', updateActiveCategoryOnScroll);
window.addEventListener('DOMContentLoaded', updateActiveCategoryOnScroll);

// עדכון תג הסינון כשמשתמשים בסינון המתקדם
function updateFilterBadge() {
  const badge = document.getElementById('selectedCityBadge');
  if (window.selectedCityFilters && window.selectedCityFilters.length > 0) {
    badge.textContent = `${window.selectedCityFilters.length} ערים`;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

// קריאה לעדכון התג כשהדף נטען
document.addEventListener('DOMContentLoaded', updateFilterBadge);

// Add some styles for the city buttons
const style = document.createElement('style');
style.textContent = `
  .city-btn {
    display: block;
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f9f9f9;
    cursor: pointer;
    text-align: right;
    transition: all 0.2s;
  }
  .city-btn:hover {
    background: #e9e9e9;
  }
  .city-btn.selected {
    background: #0099cc;
    color: white;
    border-color: #0088bb;
  }
`;
document.head.appendChild(style);
</script>
  <script src="location-tooltip.js"></script>
</body>
</html>
